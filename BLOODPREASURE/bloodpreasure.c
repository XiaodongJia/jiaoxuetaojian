/*
 * bloodpreasure.c
 *
 *  Created on: 2014年9月19日
 *      Author: lenovo
 */
// Basic MSP430 and driverLib #includes
#include "msp430.h"
#include <string.h>
#include "driverlib.h"
#include "driverlib/MSP430F5xx_6xx/wdt_a.h"
#include "driverlib/MSP430F5xx_6xx/ucs.h"
#include "HAL_PMM.h"
#include "driverlib/MSP430F5xx_6xx/sfr.h"

// USB API #includes
#include "USB_config/descriptors.h"
#include "USB_API/USB_Common/device.h"
#include "USB_API/USB_Common/types.h"
#include "USB_API/USB_Common/usb.h"
#include "USB_API/USB_CDC_API/UsbCdc.h"
#include "USB_app/usbConstructs.h"

// Application #includes
#include "BCUart.h"           // Include the backchannel UART "library"
#include "hal.h"              // Modify hal.h to select your hardware
#include "TFT_Screen.h"
#include<msp430f5529.h>
#include "math.h"
#include "ADC12.h"
#include "bt.h"
#include "heartrate.h"
#include "bloodpreasure.h"
#include "key.h"


#define uint unsigned int
#define uchar unsigned char
volatile int x,section;
uint rred[50];
uint ddcc[50];
volatile int n;
uint maxt,t1,pkn;
uint delta=400;
uint max1,min;
int i,j;
volatile int flag;
uint flagg;
volatile int xaxis;
volatile int xx,mm;
uint shp,rep;
uint sh,re;
uchar str1[5];
WORD rxByteCount;                        // Momentarily stores the number of bytes received
BYTE buf_bcuartToUsb[BC_RXBUF_SIZE];     // Same size as the UART's rcv buffer
BYTE buf_usbToBcuart[128];               // This can be any size
//char degc;
long temp_final1,temp_final2;

const unsigned char BPhan[10][128]={
        {0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x02,0x38,0x00,0x06,0x0D,0xF8,0x80,0x81,0x0C,0xE0,0xC1,0x40,0x0C,0x80,0x33,0x20,0x0C,0x00,0x1E,0x30,0x0C,0x00,0x0C,0x10,0x0C,0x00,0x1E,0x10,0x0C,0x00,0x16,0x18,0x3C,0x00,0x33,0x08,0x06,0x80,0x21,0x08,0x02,0x80,0x41,0x0C,0x02,0xC0,0x40,0x0C,0x03,0x40,0x80,0x0C,0x01,0x60,0x80,0x0C,0x01,0xE0,0xFF,0x8F,0x00,0x00,0x18,0x8C,0x0C,0x00,0x18,0x4C,0x0C,0x00,0x18,0x4C,0x1C,
        0x40,0x18,0x4C,0x18,0x20,0x18,0x2C,0x20,0x38,0x18,0x2C,0x00,0xF8,0xFF,0x2F,0x00,0x10,0x18,0x18,0x01,0x00,0x18,0x00,0x03,0x00,0x18,0x00,0x03,0x00,0x18,0x00,0x06,0x00,0x18,0x00,0x04,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"波",0*/

        {0x00,0x00,0x00,0x00,0x00,0x80,0x01,0x00,0x00,0x60,0x04,0x20,0x00,0x18,0x02,0x10,0x00,0x0C,0x02,0x08,0x00,0x07,0x02,0x0C,0x80,0x01,0x02,0x04,0xC0,0x00,0x02,0x06,0x60,0x00,0x02,0x02,0x38,0x00,0x02,0x03,0x1C,0x00,0x02,0x03,0x08,0x20,0x02,0x01,0x00,0x18,0x82,0x01,0x00,0x04,0x82,0x01,0x00,0x03,0x82,0x01,0x80,0x01,0x82,0x01,0xC0,0x00,0x82,0x01,0x60,0xF0,0xFF,0x3F,0x78,0x60,0x82,0x01,0x30,0x00,0x82,0x01,
        0x00,0x10,0x82,0x01,0x00,0x0C,0x82,0x01,0x00,0x06,0x82,0x01,0x00,0x03,0x82,0x01,0x80,0x01,0x82,0x01,0xC0,0x00,0x82,0x01,0xE0,0xF0,0xFF,0x1F,0x70,0xE0,0x00,0x00,0x20,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"形",1*/

        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0xFF,0xFF,0x1F,0x38,0x30,0x0C,0x00,0x10,0x30,0x0C,0x00,0x00,0x38,0x8C,0x00,0x00,0x36,0x8C,0x01,0x00,0x33,0x8C,0x01,0x80,0x31,0x8C,0x03,0xC0,0x30,0x0C,0x03,0xC0,0x30,0x0C,0x06,0x70,0x30,0x0C,0x0C,0x70,0x30,0x0C,0x08,0x20,0x38,0x0C,0x00,0x00,0x20,0x08,0x00,0x00,0x01,0x80,0x00,0x80,0xFF,0xFF,0x00,0x80,0x01,0x80,0x00,0x80,0x01,0x80,0x00,
        0x80,0x01,0x80,0x00,0x80,0x01,0x80,0x00,0x80,0xFF,0xFF,0x00,0x80,0x01,0x80,0x00,0x80,0x01,0x80,0x00,0x80,0x01,0x80,0x00,0x80,0x01,0x80,0x00,0x80,0xFF,0xFF,0x00,0x80,0x01,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"显",2*/

        {0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x07,0x00,0x00,0x80,0x1F,0x00,0x00,0x80,0x73,0x20,0x10,0x80,0x01,0x10,0x38,0x80,0x01,0x18,0x38,0x80,0x01,0x0C,0x70,0x80,0x01,0x06,0x60,0x80,0x01,0x03,0xC0,0x80,0x81,0x03,0x80,0x81,0x81,0x01,0x00,0x83,0xC1,0x00,0x00,0x86,0xE1,0x00,0x00,0x88,0x71,0x00,0x00,0x80,0x41,0x00,0x00,0x80,0x01,0x00,0x00,0x80,0x01,0x00,0xFE,0xFF,0xFF,0x3F,0x3C,0x00,0x00,0x00,
        0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0xFF,0x03,0xE0,0x01,0x00,0x00,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"示",3*/

        {0x00,0x00,0x00,0x00,0x00,0x00,0x58,0x00,0x38,0x00,0x46,0x00,0x7E,0x00,0x41,0x00,0xE0,0xC0,0x40,0x00,0xC0,0x61,0x40,0x00,0x00,0x33,0x40,0x00,0x00,0x1E,0x40,0x00,0x00,0x0C,0x40,0x10,0x00,0x1E,0x40,0x18,0x00,0x1E,0x40,0x1C,0x00,0x12,0x40,0x1B,0x00,0x33,0xC0,0x18,0x00,0x23,0x40,0x18,0x00,0x61,0x40,0x18,0x80,0x41,0x48,0x18,0x80,0x41,0x48,0x18,0x80,0x41,0x44,0x18,0x80,0x80,0x46,0x18,0xC0,0x80,0x42,0x18,
        0xC0,0x80,0x43,0x18,0xC0,0x80,0x41,0x18,0xFC,0xFF,0x41,0x18,0x18,0x80,0x41,0x18,0x00,0x80,0x40,0x00,0x00,0xC0,0x40,0x00,0x00,0xC0,0x40,0x00,0x00,0xE0,0x40,0x00,0x00,0x60,0x60,0x00,0x00,0x60,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"收",0*/

        {0x00,0x00,0x00,0x00,0x20,0x20,0x06,0x00,0x30,0x30,0x06,0x00,0x30,0x30,0x06,0x00,0xF0,0x3F,0x06,0x20,0x30,0x30,0x06,0x38,0x30,0x30,0x06,0x1F,0x30,0x30,0xE6,0x00,0x30,0x30,0x06,0x00,0x30,0x30,0x06,0x00,0xF0,0x3F,0x46,0x00,0x30,0x30,0x26,0x18,0x30,0x30,0xD6,0x3F,0x30,0x30,0x1E,0x18,0x30,0x30,0x0E,0x0C,0xF0,0x3B,0x0E,0x04,0x30,0x34,0x07,0x02,0x00,0x02,0x06,0x03,0x00,0x02,0x82,0x31,0x00,0x03,0x83,0x3F,
        0xE0,0x7F,0xC3,0x30,0x1C,0x80,0x61,0x10,0x08,0x80,0x79,0x08,0x20,0x00,0x0D,0x0C,0x10,0x00,0x04,0x04,0xFC,0xFF,0x07,0x06,0x08,0x04,0x04,0x02,0x00,0x0C,0x00,0x03,0x00,0x0C,0x80,0x03,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"缩",1*/

        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0xFE,0xFF,0xFF,0x13,0x3C,0xC0,0x00,0x10,0x18,0xC0,0x00,0x08,0x00,0xC0,0x00,0x0C,0xC0,0xC0,0x00,0x0C,0xC0,0xC0,0x00,0x04,0xC0,0xC1,0x00,0x06,0x80,0xC1,0x00,0x06,0x00,0xC3,0x00,0x06,0x00,0xC6,0x00,0x02,0x00,0xC0,0x00,0x02,0x00,0xC0,0x00,0x02,0x00,0xC0,0x00,0x03,0xE0,0xFF,0x7F,0x03,0xC0,0xC0,0x00,0x03,0x00,0xC0,0x00,0x03,0x00,0xC0,0x00,0x03,
        0x00,0xC0,0x00,0x03,0x00,0xC0,0x00,0x03,0x00,0xC0,0x00,0x03,0x00,0xE0,0x00,0x03,0x00,0xE0,0x00,0x03,0x00,0x80,0x00,0x03,0x00,0x00,0x00,0x03,0xF8,0xFF,0xFF,0x03,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"压",2*/

        {0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x08,0x00,0x0E,0x00,0x04,0x00,0x7E,0x06,0x04,0x00,0x02,0xFE,0x07,0x00,0x02,0x06,0x04,0x00,0x02,0x06,0x04,0x00,0x02,0x06,0x04,0x00,0x02,0x06,0x04,0x00,0x02,0x06,0x04,0x00,0x02,0xFE,0x07,0x00,0x02,0x46,0x04,0x00,0x02,0x40,0x00,0x00,0x02,0x40,0x00,0x20,0x02,0x40,0x00,0x10,0x02,0xFF,0x3F,0x18,0x02,0x42,0x00,0xFC,0xFF,0x40,0x40,0x18,0x00,0x40,0x20,0x00,0x03,0x40,0x10,
        0x00,0x03,0xFE,0x0B,0x00,0x07,0x0E,0x04,0x00,0x0F,0x03,0x06,0x80,0x19,0x07,0x03,0xC0,0x00,0x0E,0x03,0x60,0x00,0x9C,0x01,0x38,0x00,0xB0,0x01,0xF0,0xFF,0xC0,0x00,0x10,0x00,0xE0,0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"舒",0*/

        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0x00,0x03,0x38,0xE0,0x80,0x0F,0x7E,0xF0,0xC0,0x10,0x70,0xCC,0xC0,0x00,0xC0,0xC2,0xC0,0x00,0x80,0xC1,0x40,0x00,0x00,0xC3,0x40,0x00,0x00,0xC2,0x40,0x00,0x00,0xC6,0x60,0x00,0x00,0xC4,0x60,0x00,0x00,0xC4,0x60,0x00,0x00,0xC8,0x60,0x10,0x00,0xC8,0xF0,0x1F,0xFC,0xFF,0x0F,0x18,0x38,0xC0,0x00,0x18,0x10,0xC0,0x00,0x18,0x00,0xE0,0x00,0x08,0x00,0xD8,0x30,0x08,
        0x00,0xCC,0xF0,0x0F,0x00,0xC6,0x30,0x00,0x00,0xC3,0x30,0x00,0xC0,0xC1,0x30,0x00,0xE0,0xC0,0x30,0x00,0x60,0xC0,0x30,0x00,0x00,0xC0,0xF0,0x1F,0x00,0xC0,0x30,0x00,0x00,0xE0,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"张",1*/

        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0xFE,0xFF,0xFF,0x13,0x3C,0xC0,0x00,0x10,0x18,0xC0,0x00,0x08,0x00,0xC0,0x00,0x0C,0xC0,0xC0,0x00,0x0C,0xC0,0xC0,0x00,0x04,0xC0,0xC1,0x00,0x06,0x80,0xC1,0x00,0x06,0x00,0xC3,0x00,0x06,0x00,0xC6,0x00,0x02,0x00,0xC0,0x00,0x02,0x00,0xC0,0x00,0x02,0x00,0xC0,0x00,0x03,0xE0,0xFF,0x7F,0x03,0xC0,0xC0,0x00,0x03,0x00,0xC0,0x00,0x03,0x00,0xC0,0x00,0x03,
        0x00,0xC0,0x00,0x03,0x00,0xC0,0x00,0x03,0x00,0xC0,0x00,0x03,0x00,0xE0,0x00,0x03,0x00,0xE0,0x00,0x03,0x00,0x80,0x00,0x03,0x00,0x00,0x00,0x03,0xF8,0xFF,0xFF,0x03,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"压",2*/
};




const unsigned char HRhan1[6][128]={


        {0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x02,0x38,0x00,0x06,0x0D,0xF8,0x80,0x81,0x0C,0xE0,0xC1,0x40,0x0C,0x80,0x33,0x20,0x0C,0x00,0x1E,0x30,0x0C,0x00,0x0C,0x10,0x0C,0x00,0x1E,0x10,0x0C,0x00,0x16,0x18,0x3C,0x00,0x33,0x08,0x06,0x80,0x21,0x08,0x02,0x80,0x41,0x0C,0x02,0xC0,0x40,0x0C,0x03,0x40,0x80,0x0C,0x01,0x60,0x80,0x0C,0x01,0xE0,0xFF,0x8F,0x00,0x00,0x18,0x8C,0x0C,0x00,0x18,0x4C,0x0C,0x00,0x18,0x4C,0x1C,
        0x40,0x18,0x4C,0x18,0x20,0x18,0x2C,0x20,0x38,0x18,0x2C,0x00,0xF8,0xFF,0x2F,0x00,0x10,0x18,0x18,0x01,0x00,0x18,0x00,0x03,0x00,0x18,0x00,0x03,0x00,0x18,0x00,0x06,0x00,0x18,0x00,0x04,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"波",0*/

        {0x00,0x00,0x00,0x00,0x00,0x80,0x01,0x00,0x00,0x60,0x04,0x20,0x00,0x18,0x02,0x10,0x00,0x0C,0x02,0x08,0x00,0x07,0x02,0x0C,0x80,0x01,0x02,0x04,0xC0,0x00,0x02,0x06,0x60,0x00,0x02,0x02,0x38,0x00,0x02,0x03,0x1C,0x00,0x02,0x03,0x08,0x20,0x02,0x01,0x00,0x18,0x82,0x01,0x00,0x04,0x82,0x01,0x00,0x03,0x82,0x01,0x80,0x01,0x82,0x01,0xC0,0x00,0x82,0x01,0x60,0xF0,0xFF,0x3F,0x78,0x60,0x82,0x01,0x30,0x00,0x82,0x01,
        0x00,0x10,0x82,0x01,0x00,0x0C,0x82,0x01,0x00,0x06,0x82,0x01,0x00,0x03,0x82,0x01,0x80,0x01,0x82,0x01,0xC0,0x00,0x82,0x01,0xE0,0xF0,0xFF,0x1F,0x70,0xE0,0x00,0x00,0x20,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"形",1*/

        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0xFF,0xFF,0x1F,0x38,0x30,0x0C,0x00,0x10,0x30,0x0C,0x00,0x00,0x38,0x8C,0x00,0x00,0x36,0x8C,0x01,0x00,0x33,0x8C,0x01,0x80,0x31,0x8C,0x03,0xC0,0x30,0x0C,0x03,0xC0,0x30,0x0C,0x06,0x70,0x30,0x0C,0x0C,0x70,0x30,0x0C,0x08,0x20,0x38,0x0C,0x00,0x00,0x20,0x08,0x00,0x00,0x01,0x80,0x00,0x80,0xFF,0xFF,0x00,0x80,0x01,0x80,0x00,0x80,0x01,0x80,0x00,
        0x80,0x01,0x80,0x00,0x80,0x01,0x80,0x00,0x80,0xFF,0xFF,0x00,0x80,0x01,0x80,0x00,0x80,0x01,0x80,0x00,0x80,0x01,0x80,0x00,0x80,0x01,0x80,0x00,0x80,0xFF,0xFF,0x00,0x80,0x01,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"显",2*/

        {0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x07,0x00,0x00,0x80,0x1F,0x00,0x00,0x80,0x73,0x20,0x10,0x80,0x01,0x10,0x38,0x80,0x01,0x18,0x38,0x80,0x01,0x0C,0x70,0x80,0x01,0x06,0x60,0x80,0x01,0x03,0xC0,0x80,0x81,0x03,0x80,0x81,0x81,0x01,0x00,0x83,0xC1,0x00,0x00,0x86,0xE1,0x00,0x00,0x88,0x71,0x00,0x00,0x80,0x41,0x00,0x00,0x80,0x01,0x00,0x00,0x80,0x01,0x00,0xFE,0xFF,0xFF,0x3F,0x3C,0x00,0x00,0x00,
        0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0xFF,0x03,0xE0,0x01,0x00,0x00,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"示",3*/

        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x00,0x00,0xFF,0x7F,0xFE,0xFF,0xFF,0x00,0xFC,0x87,0xC4,0x00,0x00,0x86,0xCC,0x00,0x00,0xC2,0xCC,0x00,0x00,0xC3,0xCC,0x00,0x00,0x43,0x8C,0x00,0x00,0x43,0x88,0x00,0x80,0x61,0x88,0x01,0x80,0x61,0x88,0x01,0xC0,0x61,0xF8,0x03,0xC0,0xC1,0x3F,0x00,0x80,0x7F,0x10,0x00,0x00,0x03,0x08,0x00,
        0x00,0x00,0x0C,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x07,0x00,0x00,0x80,0x03,0x00,0x00,0x80,0x03,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"血",0*/

        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x10,0x00,0xC0,0xFF,0x08,0xF8,0xFF,0x03,0x0C,0xF0,0x60,0x00,0x06,0x00,0x60,0x00,0x06,0x80,0x60,0x00,0x03,0x80,0x61,0x00,0x03,0x80,0x63,0x00,0x01,0x00,0x62,0x80,0x01,0x00,0x60,0x80,0x01,0x00,0xFC,0x87,0x01,0x00,0x7F,0x80,0x00,0x00,0x60,0xC0,0x00,0x00,0x60,0xC0,0x00,0x00,0x60,0xC0,0x00,
        0x00,0x60,0xC0,0x00,0x00,0x70,0xC0,0x00,0x00,0xE0,0xC0,0x00,0x00,0x00,0xC0,0x00,0x00,0xE0,0xFF,0x00,0x00,0xFF,0x81,0x00,0x00,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"压",1*/
  };


static unsigned int g = 0;



void drawbpletter(){
      //Show_ALLTHEME();
      DRAW_Other(450,280,11); //B
      DRAW_Other(430,280,12); //P
      DRAW_han(420,310,BPhan[0]);
      DRAW_han(380,310,BPhan[1]);
      DRAW_han(340,310,BPhan[2]);
      DRAW_han(300,310,BPhan[3]);
      DRAW_Other(250,274,2);
      DRAW_LINE(15,60,465,60,RED);

      //收缩压
      DRAW_han(460,48,BPhan[4]);
      DRAW_han(428,48,BPhan[5]);
      DRAW_han(396,48,BPhan[6]);
      DRAW_Other(348,20,2); //:
      //舒张压
      DRAW_han(228,48,BPhan[7]);
      DRAW_han(196,48,BPhan[8]);
      DRAW_han(164,48,BPhan[9]);
      DRAW_Other(116,20,2); //:

  }
int_aerate(){
	  P2DIR |= BIT5;                       // P1.3 and P1.4 output
	  P2SEL |= BIT5;                      // P1.3 and P1.4 options select
	  TA2CCR0 = 2000;                          // PWM Period
	  //TA2CCTL1 = OUTMOD_7;                      // CCR1 reset/set
	  //TA2CCR1 = 2000;                            // CCR1 PWM duty cycle
	  TA2CCTL2 = OUTMOD_7;                      // CCR2 reset/set
	  TA2CCR2 = 2000;
	  TA2CTL = TASSEL_2 + MC_1 + TACLR+ID__2;
	   	P6DIR|=BIT2;
	   	P6OUT|=BIT2;
	    while(x<3900){   //充气到140mmHg 3100   120mmhg   4060
	   		_NOP();
	   	}
	   	//TA2CCR1 = 0;                            // CCR1 PWM duty cycle
	   	TA2CCR2 = 1400;                         //放气215 250 290
	   	P6OUT&=~BIT2;
	   	i=100;
   	 	while(i>0){
   	 		int j=500;
   	 		while(j>0){j--;_NOP();}
   	 		i--;

   	 	}
   	 	section=1;                       //开始绘制曲线


   	 //	i=5000;
   	 /*	while(i>0){
   	 		int j=5000;
   	 		while(j>0){j--;_NOP();}
   	 		i--;
   	 	}
   		//TA2CCR2 = 140;                //开始加速放气
*/

}
int_adc12()
{
	P6SEL |= BIT0 +   BIT1;   //p6.0，p6.1作为输入口
	REFCTL0 |= REFMSTR+REFVSEL_2+REFON+REFTCOFF;
	ADC12CTL0 |= ADC12ON+ADC12REF2_5V+ADC12REFON+ADC12SHT0_15;//打开ADC12内核
	ADC12CTL1 = ADC12CONSEQ_3+ ADC12SSEL_1+ADC12SHS_2;//序列通道多次转换模式+ACLK+定时器B触发采样
	ADC12MCTL0 = ADC12SREF_1+ADC12INCH_0;//p6.0为0通道
	ADC12MCTL1 = ADC12SREF_1+ADC12INCH_1+ADC12EOS;//p6.1为1通道
	ADC12CTL2 |= ADC12REFOUT;
	ADC12IE = 0x00;
	ADC12IE = ADC12IE1;// ADC12IE2;//允许2通道中断
	TB0CCTL0=0x0080; //定时器B输出为翻转模式
	TB0CCR0=150;//采样率??
	TB0CTL=TBSSEL_1+MC_1+TBCLR; //ACLK+增模式+CLEAR
	ADC12CTL0 |= ADC12ENC;//允许启动AD转换
}
void smooth(){
	for(i=10;i<1500;i++){
		if(abs(results1[i]-results1[i-1])>delta&&abs(results1[i]-results1[i+1])>delta) results1[i]=results1[i-1];  //去除毛刺
	}
	for(i=10;i<1500;i++){
		results1[i]=results1[i]*0.7+results1[i-1]*0.3;    //一阶滞后滤波
	}
}
int_findpk(){
	uint16_t t[50];
	uint R2h[50];

	for(i=10;i<1500;i++){
		if(results1[i]>=results1[i-1]&&results1[i]>=results1[i-2]&&results1[i]>=results1[i+1]&&results1[i]>=results1[i+2]&&(i-t1)>40){//找到最大值
			flagg=1;
			for(j=0;j<15;j++){if(results1[i+j-7]>results1[i]) flagg=0;}  //在区间15内验证最大值
			if (flagg==1){R2h[pkn]=results1[i];t[pkn]=i;pkn++;t1=i;}//确认最大值
		}
	}
	t[pkn]=1500;
	for(i=0;i<pkn;i++){
		min=results1[t[i]];
		double sum=0;
		for(j=t[i];j<t[i+1];j++){
			if(results1[j]<min) min=results1[j];//两个最大值之间找到最小值
			sum+=results[j]/100;
		}
		ddcc[i]=floor(sum*100/(t[i+1]-t[i]+1));//求区间的平均袖带压力
		rred[i]=results1[t[i]]-min;          //峰峰值
	}

}
void findBP(){
	max1=0;
	for(i=0;i<pkn;i++){
		if (rred[i]>max1) {max1=rred[i];maxt=i;}
	}
	int de=abs(rred[0]-0.3*max1);
	for(i=0;i<maxt;i++){
		if(abs(rred[i]-0.3*max1)<=de) {
			shp=(ddcc[i]-2490)/9;     //收缩压
			de=abs(rred[i]-0.3*max1);
		}
	}
	de=abs(rred[0]-0.65*max1);
	for(i=maxt;i<pkn;i++){
		if(abs(rred[i]-0.65*max1)<=de) {
			rep=(ddcc[i]-2510)/9;       //舒张压
			de=abs(rred[i]-0.65*max1);
		}
	}
	 sh=shp;
	 re=rep;
/*	for(i=2;i>=0;i--){            //血压按位分离出个位、十位、百位
		s[i]=shp%10;
		shp=shp/10;
		d[i]=rep%10;
		rep=rep/10;
	}*/

    unsigned int temp1,temp10,temp100;

    temp1=shp%10;             //个位
    temp10=(shp%100-temp1)/10;    //十位
    temp100=(shp-temp10*10-temp1)/100;    //百位
    temp_final1=(long)(temp1+temp10*10+temp100*100);
    if(temp100>0)    DRAW_NUM(332,20,temp100,BLUE);  //显示百位
    DRAW_NUM(316,18,temp10,BLUE);         //显示十位
    DRAW_NUM(300,18,temp1,BLUE);       //显示个位

    temp1=rep%10;             //个位
    temp10=(rep%100-temp1)/10;    //十位
    temp100=(rep-temp10*10-temp1)/100;    //百位
    temp_final2=(long)(temp1+temp10*10+temp100*100);
    if(temp100>0)    DRAW_NUM(100,20,temp100,BLUE);  //显示百位
    DRAW_NUM(84,18,temp10,BLUE);         //显示十位
    DRAW_NUM(68,18,temp1,BLUE);       //显示个位

}
void BP(int transmit_mode){
	USE_LCD();

	_DINT();
	buttonsPressed=0;

    Init_UART2();
    UCA0IE |= UCRXIE;



	int ad_f ;
	ad_f = 0;
    SPILCD_Clear(WHITE);
    drawbpletter();   //draw 'BLOOD PRESURE'

//    PMM_setVCore(PMM_BASE, PMM_CORE_LEVEL_3);
    initClocks(20000000);   // Config clocks. MCLK=SMCLK=FLL=8MHz; ACLK=REFO=32kHz

    int_adc12();
    //bcUartInit();          // Init the back-channel UART
//    USB_setup(TRUE,TRUE);  // Init USB; if a USB host (PC) is present, connect

    n=0;xaxis=0;flag=0;xx=0;mm=0;t1=0;pkn=0;section=0;x=0;
//   	int_adc12();//采样设置
    ADC12CTL0 |= ADC12SC;//启动采样
    ADC12CTL0 |= ADC12ENC+ADC12ON;
    ad_f = 0;
   	_EINT();//允许中断

  int_aerate();  //启动气阀自动充放气
   	 	//section=1;
  //int_adc12();
  while(n<500);
 // TA2CCR2 = 600;
  while(n<1000);
//  TA2CCR2 = 350;
  while(n<1400){           //等待采1500个样点
       // _EINT();
//__bis_SR_register(LPM0_bits + GIE); //低功耗，使能全局中断
 		_NOP();

 	}
 //	TA2CCR2 = 200;
 	while(n<1500);
 	_DINT();
 	ADC12IE &= ~0x02;
 	ADC12CTL0 &=~ ADC12ENC;      //停止转换
 	TA2CCR2 =0;
 	smooth();       //滤波
 	int_findpk();//找到脉搏波峰峰值
 	findBP();  //计算并显示血压


 	_EINT();


//    long a;
//    char b[5];
//    char c[3];
//    char cc[3];
/*    ltoa(temp_final1,b);
    if(temp_final1>=0&&temp_final1<=9)
    {
    c[0]='0';
    c[1]='0';
    c[2]=b[0];
    }
    if(temp_final1>=10&&temp_final1<=99)
    {
    c[0]='0';
    c[1]=b[0];
    c[2]=b[1];
    }
    if(temp_final1>=100&&temp_final1<=999)
    {
    c[0]=b[0];
    c[1]=b[1];
    c[2]=b[2];
    }

    ltoa(temp_final2,b);
    if(temp_final2>=0&&temp_final2<=9)
    {
    cc[0]='0';
    cc[1]='0';
    cc[2]=b[0];
    }
    if(temp_final2>=10&&temp_final2<=99)
    {
    cc[0]='0';
    cc[1]=b[0];
    cc[2]=b[1];
    }
    if(temp_final2>=100&&temp_final2<=999)
    {
    cc[0]=b[0];
    cc[1]=b[1];
    cc[2]=b[2];
    }
*/
    //char end[3]={'E','N','D'};
    int i;

      /*
       */
//    CRCresult=0;
           for(i=1508;i>=9;i--){
               results1[i]=results1[i-9]>>5;
           }
//           for(i=9;i<1509;i++)
//           {
//               CRCtmp = CRCresult%256;
//               CRCindex = CRCtmp^results1[i];
//               CRCtmp = CRCresult/256;   //除以256
//               CRCresult = CRCtmp;
//               CRCresult = CRCresult^CRC_TA[CRCindex];
//           }
//           a=CRCresult;
//           ltoa(a,b);
           results1[0]='S';
           results1[1]='T';
           results1[2]='A';
           results1[3]='R';
           results1[4]='T';
           results1[5]='B';
           results1[6]='P';
           if(sh>=127){
           results1[7]=0x7F;
           results1[8]=(char)(sh-127);}
           else{
         	  results1[7]=(char)(sh);
         	  results1[8]=0;
           }
           if(re>=127){
           results1[9]=0x7F;
           results1[10]=(char)(re-127);}
           else{
         	  results1[9]=(char)(re);
         	  results1[10]=0;
           }
           results1[1511]='A';
           results1[1512]='A';
           results1[1513]='A';
           results1[1514]='A';
           results1[1515]='A';
           results1[1516]='E';
           results1[1517]='N';
           results1[1518]='D';

    if(transmit_mode==1){
    	bcUartInit();
        bcUartSend_char(results1,1519);//buf_bcuartToUsb
    }


    if(transmit_mode==2){
           hidSendDataInBackground(results1,3038, HID0_INTFNUM,10000);
    }


    if(transmit_mode==3){
    	Init_UART2();

        	 int i;
        	 for(i=0;i<1519;i++)
        	 {
                 UCA0TXBUF = results1[i];

                 while(!(UCTXIFG==(UCTXIFG & UCA0IFG))&&((UCA0STAT & UCBUSY)==UCBUSY));

                 int a,k;
                 for(a=0;a<10;a++)
                 {
                      for(k=0;k<80;k++);
                 }
        	 }
         }

    __no_operation();                       // For debugger

    _EINT();

    Init_UART2();
    UCA0IE |= UCRXIE;

    buttonsPressed=0;
    BUTTON_S4=0;
    while(!(buttonsPressed & BUTTON_S4));
 /***************UART**************************/
 //	 rxByteCount = 1500;//bcUartReceiveBytesInBuffer(buf_bcuartToUsb);
 	// bcUartSend(results1,rxByteCount);//buf_bcuartToUsb
 	 //bcUartSend(results,rxByteCount);
/***************USB**************************/
 /*	 for(i=0;i<1500;i++){
 		 convertTwoDigBinToASCII(results1, str1);
 		 __delay_cycles(110000);
 		 hidSendDataInBackground(str1,5, HID0_INTFNUM,0);
 	 }
 	for(i=0;i<1500;i++){
 	 		 convertTwoDigBinToASCII(results, str1);
 	 		 __delay_cycles(110000);
 	 		 hidSendDataInBackground(str1,5, HID0_INTFNUM,0);
 	 	 }*/
/***************BlueTooth**************************//*
 	long a;
 	char b[20];
 	char c[2];
 	int bb;
 	Init_UART1();
 	for(i=0;i<1500;i++){
 		a=(long)results1[i]/40;
 		if(a>=0&&a<=9){
 			ltoa(a,b);
 			c[0]='0';
 			c[1]=b[0];
 		}
 		 if(a>=10&&a<=99){
 			 ltoa(a,b);
 			 c[0]=b[0];
 			 c[1]=b[1];
 		 }
 		 for(bb=0;bb<2;bb++){
 		 degc=c[bb];
 		UCA0IE |= UCTXIE;
 		for(i=0;i<500;i++){
 			for(j=0;j<100;j++);
 		}
 		 }
 	}
 	*/
}

